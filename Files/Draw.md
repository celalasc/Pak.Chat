# План улучшения взаимодействия с файлами и рисовалки

## Анализ текущих проблем

### 1. Проблема с Recent Files
**Суть проблемы:** Файлы добавляются в recent ДО отправки сообщения, что приводит к ошибкам после перезагрузки.

**Текущее поведение:**
- В `useRecentFilesIntegration()` файлы добавляются в recent сразу при добавлении в `AttachmentsStore`
- Это происходит в строке `addToRecent(newAttachment.file)` когда `state.attachments.length > prevState.attachments.length`
- После перезагрузки blob URLs недоступны, файлы нельзя повторно выбрать

**Корень проблемы:**
- Файлы добавляются в recent на этапе прикрепления (в AttachmentsStore)
- А не после успешной отправки сообщения

### 2. Проблема с DrawingCanvas на мобильных устройствах
**Анализ текущей реализации:**
- Canvas фиксированного размера 800x600
- Нет адаптации под размер экрана
- Неудобные контролы для тач-взаимодействия
- Палитра цветов и инструменты не оптимизированы для мобильных

---

## План решения проблем

### Задача 1: Исправление логики Recent Files
**Цель:** Файлы должны добавляться в recent ТОЛЬКО после успешной отправки сообщения.

#### Подзадачи:
1. **F1.1** Удалить автоматическое добавление в recent из `useRecentFilesIntegration`
   - Убрать подписку на изменения AttachmentsStore
   - Файлы не должны попадать в recent при прикреплении

2. **F1.2** Добавить добавление в recent после успешной отправки
   - В `handleSubmit` в ChatInput.tsx после успешного `sendMessage`
   - Добавлять ТОЛЬКО при успешной отправке (без ошибок)
   - Критерий успеха: `dbMsgId` получен и `savedAttachments` сохранены

3. **F1.3** Создать отдельную функцию для добавления в recent
   - `addFileToRecent(file: File)` в RecentFilesDropdown или отдельном утиле
   - Экспортировать для использования в ChatInput

4. **F1.4** Улучшить обработку ошибок в recent files
   - Валидация файлов при загрузке из localStorage
   - Очистка неактуальных записей
   - Уведомления пользователю о проблемах

#### Критерии успеха F1:
- [ ] Файлы НЕ добавляются в recent при прикреплении
- [ ] Файлы добавляются в recent ТОЛЬКО после успешной отправки сообщения
- [ ] После перезагрузки нет ошибок при клике на recent files
- [ ] Показывается адекватное сообщение пользователю при клике на recent файл

---

### Задача 2: Улучшение DrawingCanvas для мобильных
**Цель:** Сделать рисовалку удобной и функциональной на мобильных устройствах.

#### Подзадачи:
2. **D2.1** Адаптивный размер canvas
   - Динамическое определение размера экрана
   - Canvas должен занимать максимально доступное пространство
   - Поддержка landscape/portrait ориентации

3. **D2.2** Оптимизация UI для мобильных
   - Увеличить размер кнопок инструментов (минимум 44px)
   - Панель инструментов внизу экрана для лучшей досягаемости
   - Swipe жесты для быстрого переключения инструментов
   - Компактная палитра цветов

4. **D2.3** Улучшение touch взаимодействий
   - Поддержка multi-touch (pinch to zoom)
   - Лучше обработка touch events (preventDefault для скролла)
   - Поддержка pressure sensitive drawing (если доступно)
   - Улучшенная точность рисования

5. **D2.4** Мобильно-специфичные функции
   - Кнопка "Отменить" удобно расположена
   - Быстрый доступ к ластику
   - Возможность скрыть/показать панель инструментов
   - Полноэкранный режим рисования

6. **D2.5** Performance оптимизации
   - Throttle для touch events
   - Оптимизация перерисовки canvas
   - Lazy loading для сложных элементов

#### Критерии успеха D2:
- [ ] Canvas корректно отображается на всех размерах мобильных экранов
- [ ] Все кнопки легко нажимаются пальцем
- [ ] Рисование плавное и отзывчивое
- [ ] Интерфейс интуитивно понятен на мобильных
- [ ] Нет проблем с производительностью

---

## Последовательность выполнения

### Этап 1: Исправление Recent Files (приоритет ВЫСОКИЙ)
1. F1.1 → F1.2 → F1.3 → F1.4

### Этап 2: Улучшение DrawingCanvas (приоритет СРЕДНИЙ)  
1. D2.1 → D2.2 → D2.3 → D2.4 → D2.5

---

## Технические детали

### Recent Files - изменения в коде:
**Файлы для изменения:**
- `frontend/components/RecentFilesDropdown.tsx` - убрать автодобавление
- `frontend/components/ChatInput.tsx` - добавить логику после отправки
- Возможно создать `frontend/lib/recentFiles.ts` для утилит

### DrawingCanvas - изменения в коде:
**Файлы для изменения:**
- `frontend/components/DrawingCanvas.tsx` - основные изменения
- Возможно CSS изменения в globals.css для мобильных стилей

---

## Риски и ограничения

### Recent Files:
- **Риск:** Может сломаться существующий UX если пользователи привыкли к текущему поведению
- **Решение:** Добавить уведомления о том, что файл будет в recent после отправки

### DrawingCanvas:
- **Риск:** Изменения могут повлиять на desktop UX
- **Решение:** Использовать `useIsMobile` для условного рендеринга

---

## Метрики успеха

### Recent Files:
1. Количество ошибок "файл не найден" = 0
2. Пользователи понимают новую логику (через feedback)

### DrawingCanvas:
1. Время рисования простой фигуры на мобильном < 10 секунд  
2. Удобство использования по 5-балльной шкале > 4
3. Отсутствие жалоб на производительность

---

## Следующие шаги

1. **Планировщик:** Одобрить план
2. **Исполнитель:** Начать с F1.1 - удаления автодобавления в recent
3. **Тестирование:** После каждой подзадачи проверять функциональность
4. **Итерация:** Собирать feedback и улучшать

---

*Документ создан для координации работы между Планировщиком и Исполнителем в рамках улучшения файлового взаимодействия и мобильной рисовалки в приложении Pak.Chat.* 